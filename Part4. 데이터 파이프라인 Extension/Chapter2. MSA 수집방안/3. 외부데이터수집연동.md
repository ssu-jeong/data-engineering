## 외부데이터수집연동

---

### 외부서비스 Event 데이터

예) 050시스템, appsflyer, adbrix

![2-3-1](https://user-images.githubusercontent.com/86764734/161762867-c66e2c41-2751-479e-a418-dc2d7cd7e170.png)


요즘에 외부에 앱이나 웹에서 발생한 그런 이벤트들을 수집하는 여러가지 서비스가 많다. 외국의 여러 사스서비스가 있는데. 저희 앱이나 웹에서 발생한그런 이벤트들을 수집하거나, 050시스템을 통해 고객과 회사가 고르게 연결되도록 하는 appsflyer, adbrix (→ 마케팅 서비스)이 그런 것들이다.

거기서 발생한 이벤트를 수집하기 위해서 앱이나 웹에 소스코드를 담는다. url을 넣고 수집하고자 하는 태깅들을 계속 넣어서 관리를 한다. 그런것 처럼 똑같이 데이터들을 넣어서 마케팅이 얼마나 효과가 좋은지 측정값으로 사용하고 있다.

그런 경우에 사용자가 통화를 하게 되면 통화를 시작하게 되는 시간, 통화시간, 통화종료시간 까지 해서 자체 050시스템을 지원하는 서비스에 저장을 한다. 그 저장된 값을 이벤트가 끝나자마자 이제 로컬에 있는 데이터 분석을 위해서 050에 있는  데이터인 통화한 내용을 알 고 싶으면 그 내역을 받아서 분석할 수 있도록 받는다. 그럴때 보통 http/post방식으로 받는다. get 방식은 메세지 사이즈가 한정적이고 작기 때문에 get으로 할 경우는 메세지가 작아서 전달내용이 다 전달되기 어렵다. 그래서 post 방식으로 보통 사용한다. 

이렇게 이벤트가 발생할 때 바로 넘겨주는 방식을 webhook방식이라고 말한다.

### appsflyer

![2-3-2](https://user-images.githubusercontent.com/86764734/161762877-7578cb4c-58b7-4b0b-84b1-3d45782fc00f.png)

보통 앱이나 웹에서 개발자들이 어떤 데이터를 수집할 건지를 기획이나 이런데서 받게 되면 그 데이터를 남길 수 있도록 소스코드에 코딩을 해서 배포를 하게 된다. 그래서 배포된 앱이나 웹에서 appsflyer에서 제공하는  sdk를 받아서 프로그래밍을 하면 appsflyer라는 서비스가 그 데이터를 수집하게 된다. 수집한 데이터는 이벤트에 사용자들이 얼마나 반응을 했는지 어느 채널에서 가장 많이 반응을 했는지 그런 부분들을 수집을 하고 데이터화 해서 보통 거기에 있는 대시보드와 같이 서비스를 제공한다. 

그 데이터를 그대로 가공한 그 바운더리안에서 제공을 해준다. 그래서 좀 제한적일 수 있다. 내부에 다른 시스템과 연결해서 분석할 수없기 때문에 보통 여기 안에서 스타트업들이 처음 시작할때 appsflyer안에 모든 데이터를 다 수집해서 분석을 하려고 한다. 그러다 보니까 개발자들한테 노드가 많이 갈 수 밖에 없다. 분석하는 채널이 여러개기 때문에 각각마다 소스코드를 수정을 해야하기 때문에 개발자들에게 노드가 많이 간다. 이런 부분도 이해를 해야 개발자들이 적게 코딩을 해서 많은 데이터를 수집할 수 있는 방안 같은 것도 우리가 고민할 부분 중 하나.

appsflyer가 가지고 있는 특징에 해당하는 데이터와 인하우스 안에 있는 데이터와 연동해서 뭔가 시너지를 발생할 수 있는 그런 데이터를 만들 수 있다면 내부에서 데이터 내제화가 필요한데 그럴 때 이런 방식을 사용한다.

앱이나 웹에서 이벤트가 발생을 하면 발생된 데이터를 호스트 방식으로 메세지를 발송을 해서 내부에 있는 시스템에 저장하는 우리같은 경우는 s3에 저장할 수 있는 방으로 저장을 했다. 그래서 내부에 있는 데이터와 연동된 데이터를 만들어서 대시보드로 각 담당자 대부분 마케팅 담당자에 제공을 하면 그런 부분이 소위 퍼포먼스 마케팅에 사용한다고 보면 된다. 

### 실습구성도

![2-3-3](https://user-images.githubusercontent.com/86764734/161762885-962e065f-4019-4921-9b7b-49f3f58ed494.png)

이전에 실습을 진행했을 때는 메세지를 application/json 이라는 형태로 했다. → 커버팅하기에 심플해서 전체적인 파이프라인을 이해하기 위해 쉽게 진행했던 것. 

그 이유는 폼방식 우리가 보통 사용하는 웹사이트에서 저장하기나 서브밋을 클릭하면 발생되는 메세지가 보통 form-url-encoded방식이다 

이제 폼방식으로 들어온 데이터를 s3에 저장하는 것을 배울 것.

주의할 점은 application/json 방식으로 들어오기 때문에 s3에 저장되는 메세지를 json으로 저장하겠다 하면 메세지 자체가 json이라 json형태로 메세지가 저장이 된다. 

그러나 form-url-encoded는 key-value 형태 → json으로 변경할 레이어를 만들어 줘야한다. 그대로 저장하면 분석하기가 어렵다...그래서 수집단에서 쉽게 할 수 있는 방법을 생각해야한다. 

보통 쉽게 구성을 할때 lambda를 사용하여 활용한다. 그것도 나쁜 방법은 아니다. api-gateway통해서 들어온다고 하면 이전에 얘기한것 처럼 velocity언어로 deploy한다면 gateway에서 내부적으로 컨버팅 작업을 쉽게 할 수 있다.

우리는 에이피타이 gateway로 실습을 할 것이다. lambda로 하면 쉽게 할 수 있는데 왜?

lambda는 fail 났을 때 다시 수행할 수 있도록 되어 있는 시스템이다. 서비스를 위한 것이기 때문에 보통 클릭을 했는데 데이터가 리턴이 안되서 에러가 난다면 다시 재기동 한다. 그렇게 4번까지 기동을 하기 때문에 만약 잘못된 오퍼레이션으로 발생을하면 데이터가 4배까지 증가할 가능성이 있다. 그래서 lambda를 사용하면 중복테이터를 체크해줘야한다.

그래서 lambda보다는 최대한 활용하지 않고 최대한 심플한 파이프라인을 구성할 수 있다.

폼형태로 들어오는 것을 json 형태로 컨버팅하는 적용한다면 약간 일반화라고 보면 되고 적용을 해놓으면 만질 일이 거의 없을거라고 생각된다. 그래서 그런 방식으로 gateway 이후의 단계에서는 다 json 형태의 데이터로 연동을 한다고 보면 된다.

json의 장점은 kinesis firehose같은 경우는 elasticserch가 Redshift에도 바로 데이더를 넣을 수가 있다. 바로 데이터를 보내서 real-time으로 분석할 수 있는 환경도 쉽게 구성할 수 있기 때문에 이런 파이프라인을 구성하는게 좋다.

### appsflyer webhook

![2-3-4](https://user-images.githubusercontent.com/86764734/161762895-dfd35e3f-20e5-4e6f-8086-f596c6eebc31.png)

우리는 이제 연결을 해줘야한다. push api라고 우리가 appsFlyer를 사용한다면 여기서 

![2-3-5](https://user-images.githubusercontent.com/86764734/161762902-c147d33b-27bd-41da-8fde-4511aceb5baf.png)


버전을 설정하고 api-gateway에서 생성한 엔드포인트를 넣어주면 된다.

![2-3-6](https://user-images.githubusercontent.com/86764734/161762911-b0c5e017-57eb-427c-a408-a4634d545421.png)

그리고 위에 메세지 중에서 우리가 남기고자 하는 메세지 타입을 선택해서 남기면 된다.

appsFlyer로 이벤트가 들어왔을 때 api-gateway로 바로 쏴줄 수 있는 시스템을 구성할 수 있다. 사실 데이터를 양쪽에 저장을 하지만 데이터를 내제화하기 떄문에 appsflyer는 특정주기로 삭제를 하면 되고 내제화된 데이터는 좀 더 디테일하게 우리가 장기간 분석할 수 있는 데이터로 engagement 그러니까 다른 데이터랑 결합해서 더 좋은 분석할 수 있는 데이터로 구성할 수 있다. 

아마 이런 경우가 많을 것이다. 직접 시스템을 구현하기 보다 최근들어서 외부시스템을 활용하면 좀 더 빠르게 마케팅이나 이런데 활용할 수 있다.

여러 외부시스템이 있다고 해도 분석은 centralize하게 데이터를 한쪽으로 내제화하는게 중요하다. 그래서 내제화해서 분석할 수 있는 환경을 구성할 수 있는 방안이라고 보면 된다. 

우리가 직접적으로 appsflyer나 그런걸 사용할 순 없어서 퀄을 사용할 건데, 더 필요한 건 외부시스템하고 연결하기 위해서는 메세지 보안이라는 부분이 있는데 거기까지는 인증서를 배포해야해서 거긴 설명으로 대체!