## 04. 지역별단지조회수실습-골드데이터생성

---

앞서 로우데이터(브론즈데이터)를 통해서 데이터 분석에 필요한 정형화된 데이터로 변형하여  데이터 카탈로그에 정의했다. 

* ODS(Operational Data Store : 운영 데이터 스토어)

S3 폴더중에 ods라고 만든 폴더가 있다. 그곳에 모든 데이터가 아닌 분석용, mysql같은 경우에 하나 만들어서 거기에 마스터성 데이터를 만들어 저장하고 s3에 있는 데이터를 보통 DBMS에 마스터테이블로 만듭니다. 

그것을 ods라고 말하는데, 우리가 비즈니스에서 사용하고 있는 여러 마스터성 테이블이 있는데 그런것들을 대부분 따로 db를 구성해서 거기에 고객마스터, 상품마스터, 매물마스터 이런 식으로해서 마스터성 데이터를 따로 dbms에 구성을 하게 된다. 

그래서 그 데이터와 우리가 정제한 데이터를 잘 조함을 해서 마트성, 그리고 우리가 골드라고 하는 즉, 우리가 좀 더 시각화 할 수 있는 형태 아니면 좀 데이터를 뭔가 sql이나 이런걸 몰라도 쉽게 접근해서 데이터를 볼 수 있는 형태로 변경해서 저장을 하는 경우를 이야기 한다. 그래서 그 경우를 실습을 통해 배워 볼 것. 

우리가 만들려고 하는 것은 대부분 이벤트 로그 안에는 보통 아이디로 구성되어 있다. 우리가 앞에서 만든거와 같이 보통은 단지 아이디 이렇게 하면 그거 외에 데이터 들은 마스터성 테이블과 조인해서 데이터를 만들어가야 마트성, 골드에 해당하는 데이터를 만들 수 있다.

![5-4-1](https://user-images.githubusercontent.com/86764734/157460205-67f19a2c-897d-4992-8a28-029b5958d0ae.png)

오른 쪽을 보면 어느 시군구 동에 어느정도 조회수가 발생을 하는지, 아니면 그 단지에 대해서 조회가 발생을 하는지 디테일한 데이터를 만들어 낼 수 있다. 

### 실습

#### Zeppelin 실행
1. import note
    
    4-3.지역별단지조회수 파일 열어주기 
    
    첫번째 단지별 사용자 조회수를 좀 더 마트성 아니면 골드데이터로 만드는 실습을 진행해 볼 것

![5-4-2](https://user-images.githubusercontent.com/86764734/157460499-f9786cac-8154-4341-95e5-208b7b8f1303.png)

대부분 sql을 만들어서 제공하고 있는데 이게 아파트에 대한 부분이라서 우리도 쉽게 이해를 할 것이라 보고 좀 더 디테일한 정보를 가지고 여러가지 조회를 자체적으로 해보자.

2. 지역별 단지조회수
    
    열어보면 이전에 mysql을 띄어 놨었는데 거기에 저장.
    
    접속정보를 찾아서 넣어보자!

3. 접속 URL 찾아봐라 엔드포인트!
    
    val url = ‘접속 url 엔트포인트 입력해주고/dm/인코딩해줘;
    
    val user = “admin”
    
    val pass = “이전에 설정해두었던 것”
    
    마스터 데이터는 dbms에 있다.

4. 실행해보기 전에 dbms에 있는 마스터 테이블을 확인.
    
    보면 현재 dw에 danji_master라고 디파인 되어 있는 것을 볼 수 있다.

![5-4-4](https://user-images.githubusercontent.com/86764734/157490094-2d3a182c-2c4f-4675-8a88-8cd91f11263e.png)

dw.danji_master 카피 해서 붙여넣어주자

이렇게 하고 실행을 해주면 우리가 앞에서 여러가지 jdbc를 통해서 dbms에 있는 데이터를 읽어오는 것을 연습했다. 그래서 실행을 하게 되면 db에 접속을 해서 이렇게 데이터에 대한 데이터셋을 가져오게 된다. 한번 조회를 하면 캐시에 넣어두기 때문에 그때그때마다 데이터를 가져오진 않는다. 

 spark는 func이 두가지(트랜스포메이션과 액션). 아직 트랜스포메이션에 대한 기능을 수행을 했고 액션에 대한 수행을 하지 않았기 떄문에 아직은 db에서 어떤 정보도 가져오지 않앗을 것!

```java
val danfiMasterQuery = """(
    select id,
    danji_name,
    sido,
    sigungu,
    dong
    from dw.danji_master) a"""
```

5. 데이터 확인
    
    단지 아이디와 단지에 대한 시도 시군구 동 정보까지 가져올 수 있다. 이런 정보로 어느지역에 아파트 관심도가 높아지는지 이런 정보를 뺄 수 있을 것!

6. spark 스키마에 있는 테이블 확인
    
    우리가 클래스라는 데이터베이스에 테이블을 만들었는데 확인을 해보자 
    
    여기 보면 temporay가 true인것은 방금 만든 뷰이다.
    
    logs는 이전에 실버데이터를 만들기 위해 만든 뷰테이블
    
    여기서 우리는 danji_user_view_sliver데이터를 가지고 골드데이터를 만들어 보도록 할것

![5-4-5](https://user-images.githubusercontent.com/86764734/157491009-8fbb9305-c140-43f7-b35b-6ee5ca9d635a.png)

7. 테이블 확인
    
    스키마 정보를 조회해보자
    
    처음엔 스키마 정보를 모르기 떄문에 디스크립션을 통해 확인을 한 후, 기존에 골드 정보(마스터성 테이블)하고 같이 조인을 해서 데이터를 만들도록 할 것

![5-4-6](https://user-images.githubusercontent.com/86764734/157491187-767f2605-4f60-4e87-9d47-a6dd2362fc07.png)

8. 마스터성 데이블 확인
    
    마스터 테이블 컬럼의 id와 위의 실버 데이터의 danji_id가 같은 키값으로 해서 조인하면 된다.

![5-4-7](https://user-images.githubusercontent.com/86764734/157491308-f981488a-0f56-4b44-b9ad-6e784c327b94.png)

9. 마스터테이블과 실버 테이블 조인
    
    조인을 걸로 그걸 단지별로 시도 시군구 동 별로 그룹바이 해서 카운트값을 구한다음에 그 값을 저장

![5-4-8](https://user-images.githubusercontent.com/86764734/157491419-ae4e4330-4543-4410-98d9-7bb869e48c23.png)

그러면 우리는 쉽게 어느 동에 어느 지금현재에는 단지 까지 확인을 할 수가 있다. 

그래서 뷰카운트로 orderby를 하게 되면 아 서울 시내에서 어느 단지가 가장 많이 조회되었는지 확인 할 수 있다. 
그런 경우 차후에 sql로 분석하는 분은 여기까지 할 수 있고, 차후에 이 데이터를 가지고 sql을 잘 모르시는 분들은 시각화로 보여줄 것 → 이 부분은 다음주 실습때

10. 구성도에서 나온건처럼 과거로 치면 하둡에 있는 데이터
    
    하둡에 있는 데이터와 dbms 데이터를 조인해서 골드 데이터로 만들어서 mysql에 저장할 것.
    
    지금은 mysql로 저장되지만 레드시프트에 저장하겠다 하면 거기다 저장하면 된다.

![5-4-9](https://user-images.githubusercontent.com/86764734/157491641-3bafdb57-b6bd-4121-a75c-5ca18e13c98b.png)

11. dm이라고 만든 테이블에 저장을 해보자

확인한 데이터를 카피한 다음에 그거를 spark.sql에 넣고

    1. 하나의 데이터 프레임으로 만들고 db에 넣어주면 된다 → sqlContext.sql()을 통해 하나의 데이터 프레임을 만들었고. 변수명을 localdanjiCountDF라고 해줌
    2. 테이블 이름은 “dm.danji_user_view)summary_gold” 이해하기 쉽게 하기 위해 골드 언급
    3. 테이블명을 정의를 하게 되면 string을 텍스트 컬럼으로 만들어서 넣어줄 것이다. 
    4. mode : append → 이 테이블은 오버롸이트라고 정의하면 전체 테이블을 드랍 시키고 저장하기 때문에 주의해야한다!만약 잘못만들어 지면 해당 날짜로 접속해서 삭제하고 다시 넣어줘야한다.

![5-4-10](https://user-images.githubusercontent.com/86764734/157491865-e3a697f8-fb4a-47df-bf6c-759108edea62.png)


12. 데이터 확인.

    - 우리가 스파크를 통해서 여러 데이터를 가공했다. 그래서 s3에 있는 데이터가 dbms에 있는 마스터성 데이터를 조인해서 새로운, 좀 더 분석에 필요한 디테일한 결과를 산출할 수 있는 골드데이터를 생성하고 mysql에 저장했다.

기존에 단지 아이디를 기반으로 생성했던 그런 단순한 실버데이터에서 좀 더 단지 이름, 시도, 시군구, 동과 같은 지역정보까지 포함된 데이터를 생성했다! 이런 데이터를 담당 관계자가 보면 흐름에 대해서 보게 될 것. 다음시간엔 각 담당자 들이 볼 수 있게 데이터를 생성을 하고 어떻게 시각화 할지 추가 실습을 진행.